[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Welcome to my website!",
    "section": "",
    "text": "Last Updated: Saturday 03 01, 2025 at 17:28PM"
  },
  {
    "objectID": "mp01.html",
    "href": "mp01.html",
    "title": "Commission to Analyze Taxpayer Spending (CATS)",
    "section": "",
    "text": "The New York City’s new Commission to Analyze Taxpayer Spending (CATS) intended to understand the city’s expenses and wondered if there were any opportunities to spend taxpayers’ money more efficiently. As a senior technical analyst, I will help analyze the city payroll and identify the instances where senior agency officials make significantly more than rank-and-file city employees. I will use City payroll data from NYC Open Data and highlight possible savings to be submitted to the commission."
  },
  {
    "objectID": "mp01.html#which-job-title-has-the-highest-base-rate-of-pay-if-needed-assume-a-standard-2000-hour-work-year-and-no-overtime.",
    "href": "mp01.html#which-job-title-has-the-highest-base-rate-of-pay-if-needed-assume-a-standard-2000-hour-work-year-and-no-overtime.",
    "title": "Commission to Analyze Taxpayer Spending (CATS)",
    "section": "3.1 Which job title has the highest base rate of pay? (If needed, assume a standard 2000 hour work year and no overtime.)",
    "text": "3.1 Which job title has the highest base rate of pay? (If needed, assume a standard 2000 hour work year and no overtime.)\n\n\nShow the code\ntotal_compensation |&gt; mutate(\n  base_rate = case_when(\n    pay_basis == \"per Annum\" ~ base_salary, \n    pay_basis == \"per Hour\" ~ base_salary * 2000,\n    pay_basis == \"per Day\" ~ base_salary * 2000/7.5,\n    TRUE ~ NA_real_  \n  )\n) |&gt; group_by(title_description) |&gt; summarize(mean_rate=mean(base_rate)) |&gt;\n  arrange(desc(mean_rate))\n\n\n# A tibble: 1,977 × 2\n   title_description                                 mean_rate\n   &lt;chr&gt;                                                 &lt;dbl&gt;\n 1 Custodian Engineer                               120870091.\n 2 Member, Civilian Complaint Review Board             639785.\n 3 Medical Investigator                                623926.\n 4 Chairman                                            379618.\n 5 Member Of The Environmental Control Board - Oath    350188.\n 6 Chief Actuary                                       296470.\n 7 Pension Investment Advisor                          295814.\n 8 Chancellor                                          287066.\n 9 Captain - Chief Of Staff                            276588 \n10 First Deputy Mayor                                  274919.\n# ℹ 1,967 more rows\n\n\nWe can see the list of job titles with the highest base rate of pay. But the first title seems an outlier, I would say the member of civilian complaint review board has the highest base rate of pay."
  },
  {
    "objectID": "mp01.html#which-individual-in-what-year-had-the-single-highest-city-total-payroll-regular-and-overtime-combined",
    "href": "mp01.html#which-individual-in-what-year-had-the-single-highest-city-total-payroll-regular-and-overtime-combined",
    "title": "Commission to Analyze Taxpayer Spending (CATS)",
    "section": "3.2 Which individual & in what year had the single highest city total payroll (regular and overtime combined)?",
    "text": "3.2 Which individual & in what year had the single highest city total payroll (regular and overtime combined)?\n\n\nShow the code\ntotal_compensation |&gt; \n  summarize(fiscal_year,first_name,last_name,total_compensation) |&gt;\n  arrange(desc(total_compensation))\n\n\n# A tibble: 6,225,611 × 4\n   fiscal_year first_name last_name   total_compensation\n         &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;                    &lt;dbl&gt;\n 1        2022 Gregory    Russ                    414707\n 2        2021 Gregory    Russ                    414707\n 3        2020 Gregory    Russ                    414707\n 4        2024 Lisa       Bova-Hiatt              393532\n 5        2024 Steven     Meier                   373320\n 6        2023 David      Banks                   363346\n 7        2023 David      Banks                   363346\n 8        2022 David      Banks                   363346\n 9        2022 Meisha     Ross Porter             363346\n10        2021 Meisha     Ross Porter             363346\n# ℹ 6,225,601 more rows\n\n\nWe can see Gregory Russ had the highest payroll of 414707 in 2020, 2021, and 2022."
  },
  {
    "objectID": "mp01.html#which-individual-worked-the-most-overtime-hours-in-this-data-set",
    "href": "mp01.html#which-individual-worked-the-most-overtime-hours-in-this-data-set",
    "title": "Commission to Analyze Taxpayer Spending (CATS)",
    "section": "3.3 Which individual worked the most overtime hours in this data set?",
    "text": "3.3 Which individual worked the most overtime hours in this data set?\n\n\nShow the code\ntotal_compensation |&gt; summarize(fiscal_year,first_name,last_name,ot_hours) |&gt;\n  arrange(desc(ot_hours))\n\n\n# A tibble: 6,225,611 × 4\n   fiscal_year first_name last_name   ot_hours\n         &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt;\n 1        2022 James      Internicola    3693.\n 2        2022 Michael    Thompson       3618.\n 3        2022 Timothy    Sands          3556.\n 4        2014 John       Murphy         3348.\n 5        2022 Seeta      Deochan        3341.\n 6        2022 Dion       Middleton      3328.\n 7        2024 Kashwayne  Burnett        3303.\n 8        2022 Anthony    Messam         3271 \n 9        2022 Davey      Payne          3241 \n10        2022 Andre      Boucaud        3214 \n# ℹ 6,225,601 more rows\n\n\nJames Internicola worked the most overtime hours of 3693."
  },
  {
    "objectID": "mp01.html#which-agency-has-the-highest-average-total-annual-payroll-base-and-overtime-pay-per-employee",
    "href": "mp01.html#which-agency-has-the-highest-average-total-annual-payroll-base-and-overtime-pay-per-employee",
    "title": "Commission to Analyze Taxpayer Spending (CATS)",
    "section": "3.4 Which agency has the highest average total annual payroll (base and overtime pay per employee)?",
    "text": "3.4 Which agency has the highest average total annual payroll (base and overtime pay per employee)?\n\n\nShow the code\ntotal_compensation |&gt; group_by(agency_name) |&gt;\n  summarize(avg_tot_pay=mean(total_compensation)) |&gt;\n  arrange(desc(avg_tot_pay))\n\n\n# A tibble: 169 × 2\n   agency_name                    avg_tot_pay\n   &lt;chr&gt;                                &lt;dbl&gt;\n 1 Office Of Racial Equity            151093.\n 2 Commission On Racial Equity        136191 \n 3 Districting Commission             120641.\n 4 Office Of Criminal Justice         117280.\n 5 Office Of Collective Bargainin     114884.\n 6 Financial Info Svcs Agency         111230.\n 7 Office Of The Actuary              106924.\n 8 Bronx Community Board #3           105814.\n 9 Public Administrator-Richmond      105752.\n10 Municipal Water Fin Authority      101300.\n# ℹ 159 more rows\n\n\nOffice of Racial Equity has the highest average total annual payroll."
  },
  {
    "objectID": "mp01.html#which-agency-has-the-most-employees-on-payroll-in-each-year",
    "href": "mp01.html#which-agency-has-the-most-employees-on-payroll-in-each-year",
    "title": "Commission to Analyze Taxpayer Spending (CATS)",
    "section": "3.5 Which agency has the most employees on payroll in each year?",
    "text": "3.5 Which agency has the most employees on payroll in each year?\n\n\nShow the code\ntotal_compensation |&gt;\n  group_by(fiscal_year, agency_name) |&gt;\n  summarize(num_empl=n(),.groups=\"drop\") |&gt;\n  group_by(fiscal_year) |&gt;\n  slice_max(num_empl,n=1)\n\n\n# A tibble: 11 × 3\n# Groups:   fiscal_year [11]\n   fiscal_year agency_name            num_empl\n         &lt;dbl&gt; &lt;chr&gt;                     &lt;int&gt;\n 1        2014 Dept Of Ed Pedagogical   100589\n 2        2015 Dept Of Ed Pedagogical   111857\n 3        2016 Dept Of Ed Pedagogical   106263\n 4        2017 Dept Of Ed Pedagogical   104629\n 5        2018 Dept Of Ed Pedagogical   107956\n 6        2019 Dept Of Ed Pedagogical   112067\n 7        2020 Dept Of Ed Pedagogical   114999\n 8        2021 Dept Of Ed Pedagogical   113523\n 9        2022 Dept Of Ed Pedagogical   120453\n10        2023 Dept Of Ed Pedagogical   106882\n11        2024 Dept Of Ed Pedagogical   108209\n\n\nDepartment of Ed Pedagogical has the most employees in every year."
  },
  {
    "objectID": "mp01.html#which-agency-has-the-highest-overtime-usage-compared-to-regular-hours",
    "href": "mp01.html#which-agency-has-the-highest-overtime-usage-compared-to-regular-hours",
    "title": "Commission to Analyze Taxpayer Spending (CATS)",
    "section": "3.6 Which agency has the highest overtime usage (compared to regular hours)?",
    "text": "3.6 Which agency has the highest overtime usage (compared to regular hours)?\n\n\nShow the code\ntotal_compensation |&gt;\n  group_by(agency_name) |&gt;\n  summarize(ot_usage=mean(ot_hours)/mean(regular_hours)) |&gt;\n  arrange(desc(ot_usage))\n\n\n# A tibble: 169 × 2\n   agency_name                  ot_usage\n   &lt;chr&gt;                           &lt;dbl&gt;\n 1 Board Of Election              0.200 \n 2 Fire Department                0.190 \n 3 Department Of Correction       0.185 \n 4 Department Of Sanitation       0.138 \n 5 Police Department              0.125 \n 6 Dept Of Citywide Admin Svcs    0.120 \n 7 Department Of Transportation   0.115 \n 8 Dept. Of Homeless Services     0.109 \n 9 Nyc Housing Authority          0.106 \n10 Admin For Children's Svcs      0.0812\n# ℹ 159 more rows\n\n\nBoard of Election has the highest overtime usage."
  },
  {
    "objectID": "mp01.html#what-is-the-average-salary-of-employees-who-work-outside-the-five-boroughs-that-is-whose-work_location_borough-is-not-one-of-the-five-counties.",
    "href": "mp01.html#what-is-the-average-salary-of-employees-who-work-outside-the-five-boroughs-that-is-whose-work_location_borough-is-not-one-of-the-five-counties.",
    "title": "Commission to Analyze Taxpayer Spending (CATS)",
    "section": "3.7 What is the average salary of employees who work outside the five boroughs? (That is, whose work_location_borough is not one of the five counties.)",
    "text": "3.7 What is the average salary of employees who work outside the five boroughs? (That is, whose work_location_borough is not one of the five counties.)\n\n\nShow the code\ntotal_compensation |&gt;\n  filter(!work_location_borough %in% c(\"Manhattan\", \"Brooklyn\", \"Queens\", \n                                     \"Bronx\", \"Richmond\")) |&gt;\n  summarize(avg_salary=mean(total_compensation,na.rm=TRUE))\n\n\n# A tibble: 1 × 1\n  avg_salary\n       &lt;dbl&gt;\n1     55503.\n\n\nThe average salary of employees working outside the New York City is 55503."
  },
  {
    "objectID": "mp01.html#how-much-has-the-citys-aggregate-payroll-grown-over-the-past-10-years",
    "href": "mp01.html#how-much-has-the-citys-aggregate-payroll-grown-over-the-past-10-years",
    "title": "Commission to Analyze Taxpayer Spending (CATS)",
    "section": "3.8 How much has the city’s aggregate payroll grown over the past 10 years?",
    "text": "3.8 How much has the city’s aggregate payroll grown over the past 10 years?\n\n\nShow the code\ngrowth &lt;- total_compensation |&gt;\n  group_by(fiscal_year) |&gt;\n  summarize(agg_pay=mean(total_compensation,na.rm=TRUE))\n\nagg_pay_2024 &lt;- growth |&gt; filter(fiscal_year==\"2024\") |&gt;\n  pull(agg_pay)\n\nagg_pay_2014 &lt;- growth |&gt; filter(fiscal_year==\"2014\") |&gt;\n  pull(agg_pay)\n\ngrowth_amount &lt;- agg_pay_2024 - agg_pay_2014\ngrowth_percentage &lt;- growth_amount/agg_pay_2014*100\ngrowth_amount\n\n\n[1] 13384.23\n\n\nShow the code\ngrowth_percentage\n\n\n[1] 32.2868\n\n\nThe city’s payroll has grown 13384.23 dollars and 32.29% over the past 10 years.\nNow, I will analyze three possible policy changes to see their impact on overall spending. I have two policies suggested and will come up with my own policy proposal for analysis. For each policy, I will i) compute its impact on city payroll, ii) determine any other staffing adjustments required, and iii) make a recommendation to the CATS."
  },
  {
    "objectID": "mp02.html",
    "href": "mp02.html",
    "title": "2025 ‘Greenest Transit’ Awards Go to…",
    "section": "",
    "text": "This year’s Greenest Transit results just came out. The greeest transit agency awards have three categories: Large, Medium and Small, in terms of the sizes of agencies. Now, Let’s announce who the winners are! The greenest agencies are respectively MTA NYC Transit, Birmingham-Jefferson County Transit Authority, and Albany Transit System. The agencies with most emissions avoided are MTA New York City Transit, Hudson Transit Lines, and Hampton Jitney. The agencies with the highest electirfication level are TriMet, University of Georgia, and Connecticut Department of Transportation. We also have “winners” for the worst performance in terms of green and they are Washington State Ferries, SeaStreak, and Alaska Railroad Corporation. The relevent metrics with their values can be found in the appendix. To better demonstrate the ‘green-ness’ of the award winners, we have created some visualizations."
  },
  {
    "objectID": "mp02.html#conclusion",
    "href": "mp02.html#conclusion",
    "title": "Environmental Efficiency of US Public Transit Systems",
    "section": "6 Conclusion",
    "text": "6 Conclusion\nThis press release announces the winners in each category. The greenest transit for large size agencies is King County Metro, in Seattle, Washington. For medium size agencies, Everett Transit in Everett, Washington is the greenest. The winner for small size agencies goes to RiverCities Transit from Longview, Washington."
  },
  {
    "objectID": "mp02.html#data-import",
    "href": "mp02.html#data-import",
    "title": "Environmental Efficiency of US Public Transit Systems",
    "section": "2 Data Import",
    "text": "2 Data Import\nWe download the EIA State Electricity Profiles, then use it to estimate the environmental impact of the electricity used to run certain transit systems.\n\n\nCode\nensure_package &lt;- function(pkg){\n    pkg &lt;- as.character(substitute(pkg))\n    options(repos = c(CRAN = \"https://cloud.r-project.org\"))\n    if(!require(pkg, character.only=TRUE)) install.packages(pkg)\n    stopifnot(require(pkg, character.only=TRUE))\n}\n\nensure_package(httr2)\nensure_package(rvest)\nensure_package(datasets)\nensure_package(purrr)\nensure_package(DT)\nensure_package(stringr)\nensure_package(dplyr)\n\nget_eia_sep &lt;- function(state, abbr){\n    state_formatted &lt;- str_to_lower(state) |&gt; str_replace_all(\"\\\\s\", \"\")\n    \n    dir_name &lt;- file.path(\"data\", \"mp02\")\n    file_name &lt;- file.path(dir_name, state_formatted)\n    \n    dir.create(dir_name, showWarnings=FALSE, recursive=TRUE)\n    \n    if(!file.exists(file_name)){\n        BASE_URL &lt;- \"https://www.eia.gov\"\n        REQUEST &lt;- request(BASE_URL) |&gt; \n            req_url_path(\"electricity\", \"state\", state_formatted)\n    \n        RESPONSE &lt;- req_perform(REQUEST)\n    \n        resp_check_status(RESPONSE)\n        \n        writeLines(resp_body_string(RESPONSE), file_name)\n    }\n    \n    TABLE &lt;- read_html(file_name) |&gt; \n        html_element(\"table\") |&gt; \n        html_table() |&gt;\n        mutate(Item = str_to_lower(Item))\n    \n    if(\"U.S. rank\" %in% colnames(TABLE)){\n        TABLE &lt;- TABLE |&gt; rename(Rank = `U.S. rank`)\n    }\n    \n    CO2_MWh &lt;- TABLE |&gt; \n        filter(Item == \"carbon dioxide (lbs/mwh)\") |&gt;\n        pull(Value) |&gt; \n        str_replace_all(\",\", \"\") |&gt;\n        as.numeric()\n    \n    PRIMARY &lt;- TABLE |&gt; \n        filter(Item == \"primary energy source\") |&gt; \n        pull(Rank)\n    \n    RATE &lt;- TABLE |&gt;\n        filter(Item == \"average retail price (cents/kwh)\") |&gt;\n        pull(Value) |&gt;\n        as.numeric()\n    \n    GENERATION_MWh &lt;- TABLE |&gt;\n        filter(Item == \"net generation (megawatthours)\") |&gt;\n        pull(Value) |&gt;\n        str_replace_all(\",\", \"\") |&gt;\n        as.numeric()\n    \n    data.frame(CO2_MWh               = CO2_MWh, \n               primary_source        = PRIMARY,\n               electricity_price_MWh = RATE * 10, # / 100 cents to dollars &\n               # * 1000 kWh to MWH \n               generation_MWh        = GENERATION_MWh, \n               state                 = state, \n               abbreviation          = abbr\n    )\n}\n\nEIA_SEP_REPORT &lt;- map2(state.name, state.abb, get_eia_sep) |&gt; list_rbind()\n\n\nWe use the following code to create a table.\n\n\nCode\nensure_package(scales)\n\nEIA_SEP_REPORT |&gt; \n    select(-abbreviation) |&gt;\n    arrange(desc(CO2_MWh)) |&gt;\n    mutate(CO2_MWh = number(CO2_MWh, big.mark=\",\"), \n           electricity_price_MWh = dollar(electricity_price_MWh), \n           generation_MWh = number(generation_MWh, big.mark=\",\")) |&gt;\n    rename(`Pounds of CO2 Emitted per MWh of Electricity Produced`=CO2_MWh, \n           `Primary Source of Electricity Generation`=primary_source, \n           `Average Retail Price for 1000 kWh`=electricity_price_MWh, \n           `Total Generation Capacity (MWh)`= generation_MWh, \n           State=state) |&gt;\n    datatable()"
  },
  {
    "objectID": "mp02.html#initial-analysis-of-sep-data",
    "href": "mp02.html#initial-analysis-of-sep-data",
    "title": "Environmental Efficiency of US Public Transit Systems",
    "section": "3 Initial Analysis of SEP Data",
    "text": "3 Initial Analysis of SEP Data\nHere are some quick facts gained using the EIA_SEP_REPORT data.\n\nHawaii has the most expensive retail electricity with a price of $386 per MWh.\n\n\n\nCode\n# Which state has the most expensive retail electricity?\nstate_highest_price &lt;- EIA_SEP_REPORT |&gt;\n  select(electricity_price_MWh, state) |&gt;\n  slice_max(electricity_price_MWh, n=1)\n\n\n\nWest Virginia, whose primary source of electricity generation is coal, has the ‘dirtiest’ electricity mix with 1925 pounds of CO2 emitted per MWh.\n\n\n\nCode\n# Which state has the 'dirtiest' electricity mix?\nstate_dirtiest_electricity &lt;- EIA_SEP_REPORT |&gt;\n  select(CO2_MWh, primary_source, state) |&gt;\n  slice_max(CO2_MWh, n=1)\n\n\n\nOn average, 805.37 pounds of CO2 are emitted per MWh of electricity produced in the US.\n\n\n\nCode\n# On average, how many pounds of CO2 are emitted per MWh of electricity produced in the US? (Note that you will need to use a suitably weighted average here.)\naverage_co2_emitted &lt;- EIA_SEP_REPORT |&gt;\n  summarize(\n    average_co2 = sum(CO2_MWh * generation_MWh) / sum(generation_MWh)\n  )\n\n\n\nPetroleum is the rarest primary energy source in the US used only in one state. The associated cost of electricity is $386 per MWh and it is used in Hawaii.\n\n\n\nCode\n# What is the rarest primary energy source in the US? \nrarest_source &lt;- EIA_SEP_REPORT |&gt;\n  group_by(primary_source) |&gt;\n  summarize(num_state_source = n()) |&gt;\n  slice_min(num_state_source, n = 1)\n\n# What is the associated cost of electricity and where is it used?\nrarest_source_table &lt;- EIA_SEP_REPORT |&gt;\n  select(primary_source, electricity_price_MWh, state) |&gt;\n  filter(primary_source == \"Petroleum\")\n\n\n\nNY’s energy mix is 1.64 times cleaner than that of Texas.\n\n\n\nCode\n# How many times cleaner is NY’s energy mix than that of Texas?\nco2_emitted_NY &lt;- EIA_SEP_REPORT |&gt;\n  filter(state == \"New York\") |&gt;\n  summarize(CO2_MWh)\n\nco2_emitted_Texas &lt;- EIA_SEP_REPORT |&gt;\n  filter(state == \"Texas\") |&gt;\n  summarize(CO2_MWh)\n\ntimes_cleaner &lt;- co2_emitted_Texas / co2_emitted_NY\n\n\nWe now download the 2023 Annual Database Energy Consumption report and do some clean up. After that, we recode the Mode column.\n\n\nCode\n# import the data: 2023 Annual Database Energy Consumption\nensure_package(readxl)\n# Create 'data/mp02' directory if not already present\nDATA_DIR &lt;- file.path(\"data\", \"mp02\")\ndir.create(DATA_DIR, showWarnings=FALSE, recursive=TRUE)\n\nNTD_ENERGY_FILE &lt;- file.path(DATA_DIR, \"2023_ntd_energy.xlsx\")\n\nif(!file.exists(NTD_ENERGY_FILE)){\n    DS &lt;- download.file(\"https://www.transit.dot.gov/sites/fta.dot.gov/files/2024-10/2023%20Energy%20Consumption.xlsx\", \n                  destfile=NTD_ENERGY_FILE, \n                  method=\"curl\")\n    \n    if(DS | (file.info(NTD_ENERGY_FILE)$size == 0)){\n        cat(\"I was unable to download the NTD Energy File. Please try again.\\n\")\n        stop(\"Download failed\")\n    }\n}\n\nNTD_ENERGY_RAW &lt;- read_xlsx(NTD_ENERGY_FILE)\n\n\n\n\nCode\n# do some basic clean-up\nensure_package(tidyr)\nto_numeric_fill_0 &lt;- function(x){\n    replace_na(as.numeric(x), 0)\n}\n\nNTD_ENERGY &lt;- NTD_ENERGY_RAW |&gt; \n    select(-c(`Reporter Type`, \n              `Reporting Module`, \n              `Other Fuel`, \n              `Other Fuel Description`)) |&gt;\n    mutate(across(-c(`Agency Name`, \n                     `Mode`,\n                     `TOS`), \n                  to_numeric_fill_0)) |&gt;\n    group_by(`NTD ID`, `Mode`, `Agency Name`) |&gt;\n    summarize(across(where(is.numeric), sum), \n              .groups = \"keep\") |&gt;\n    mutate(ENERGY = sum(c_across(c(where(is.numeric))))) |&gt;\n    filter(ENERGY &gt; 0) |&gt;\n    select(-ENERGY) |&gt;\n    ungroup()\n\n\n\n\nCode\n# clean up mode column in ntd energy\nNTD_ENERGY &lt;- NTD_ENERGY |&gt;\n    mutate(Mode=case_when(\n        Mode == \"HR\" ~ \"Heavy Rail\",\n        Mode == \"AR\" ~ \"Alaska Railroad\",\n        Mode == \"CB\" ~ \"Commuter Bus\",\n        Mode == \"CC\" ~ \"Cable Car\",\n        Mode == \"CR\" ~ \"Commuter Rail\",\n        Mode == \"DR\" ~ \"Demand Response\",\n        Mode == \"FB\" ~ \"Ferryboat\",\n        Mode == \"IP\" ~ \"Inclined Plane\",\n        Mode == \"LR\" ~ \"Light Rail\",\n        Mode == \"MB\" ~ \"Bus\",\n        Mode == \"MG\" ~ \"Monorail and Automated Guideway modes\",\n        Mode == \"PB\" ~ \"Publico\",\n        Mode == \"RB\" ~ \"Bus Rapid Transit\",\n        Mode == \"SR\" ~ \"Streetcar Rail\",\n        Mode == \"TB\" ~ \"Trolleybus\",\n        Mode == \"TR\" ~ \"Aerial Tramways\",\n        Mode == \"VP\" ~ \"Vanpool\",\n        Mode == \"YR\" ~ \"Hybrid Rail\",\n        TRUE ~ \"Unknown\"))\n\n\nNext, we download the 2023 Service by Agency report, from which we will extract characteristics of typical passenger trips on each transit service. We will also explore the data by answering some questions using the service data.\n\n\nCode\n# download the 2023 service by agency report\nlibrary(readr)\nNTD_SERVICE_FILE &lt;- file.path(DATA_DIR, \"2023_service.csv\")\nif(!file.exists(NTD_SERVICE_FILE)){\n    DS &lt;- download.file(\"https://data.transportation.gov/resource/6y83-7vuw.csv\", \n                  destfile=NTD_SERVICE_FILE, \n                  method=\"curl\")\n    \n    if(DS | (file.info(NTD_SERVICE_FILE)$size == 0)){\n        cat(\"I was unable to download the NTD Service File. Please try again.\\n\")\n        stop(\"Download failed\")\n    }\n}\n\nNTD_SERVICE_RAW &lt;- read_csv(NTD_SERVICE_FILE)\n\n\n\n\nCode\n#clean up the service data\nNTD_SERVICE &lt;- NTD_SERVICE_RAW |&gt;\n    mutate(`NTD ID` = as.numeric(`_5_digit_ntd_id`)) |&gt; \n    rename(Agency = agency, \n           City   = max_city, \n           State  = max_state,\n           UPT    = sum_unlinked_passenger_trips_upt, \n           MILES  = sum_passenger_miles) |&gt;\n    select(matches(\"^[A-Z]\", ignore.case=FALSE)) |&gt;\n    filter(MILES &gt; 0)"
  },
  {
    "objectID": "mp02.html#recoding-the-mode-column",
    "href": "mp02.html#recoding-the-mode-column",
    "title": "Environmental Efficiency of US Public Transit Systems",
    "section": "4 Recoding the mode column",
    "text": "4 Recoding the mode column\n\n\nCode\n# clean up mode column in ntd energy\nNTD_ENERGY &lt;- NTD_ENERGY |&gt;\n    mutate(Mode=case_when(\n        Mode == \"HR\" ~ \"Heavy Rail\",\n        Mode == \"AR\" ~ \"Alaska Railroad\",\n        Mode == \"CB\" ~ \"Commuter Bus\",\n        Mode == \"CC\" ~ \"Cable Car\",\n        Mode == \"CR\" ~ \"Commuter Rail\",\n        Mode == \"DR\" ~ \"Demand Response\",\n        Mode == \"FB\" ~ \"Ferryboat\",\n        Mode == \"IP\" ~ \"Inclined Plane\",\n        Mode == \"LR\" ~ \"Light Rail\",\n        Mode == \"MB\" ~ \"Bus\",\n        Mode == \"MG\" ~ \"Monorail and Automated Guideway modes\",\n        Mode == \"PB\" ~ \"Publico\",\n        Mode == \"RB\" ~ \"Bus Rapid Transit\",\n        Mode == \"SR\" ~ \"Streetcar Rail\",\n        Mode == \"TB\" ~ \"Trolleybus\",\n        Mode == \"TR\" ~ \"Aerial Tramways\",\n        Mode == \"VP\" ~ \"Vanpool\",\n        Mode == \"YR\" ~ \"Hybrid Rail\",\n        TRUE ~ \"Unknown\"))\n\n\n\n\nCode\n# download the 2023 service by agency report\nlibrary(readr)\nNTD_SERVICE_FILE &lt;- file.path(DATA_DIR, \"2023_service.csv\")\nif(!file.exists(NTD_SERVICE_FILE)){\n    DS &lt;- download.file(\"https://data.transportation.gov/resource/6y83-7vuw.csv\", \n                  destfile=NTD_SERVICE_FILE, \n                  method=\"curl\")\n    \n    if(DS | (file.info(NTD_SERVICE_FILE)$size == 0)){\n        cat(\"I was unable to download the NTD Service File. Please try again.\\n\")\n        stop(\"Download failed\")\n    }\n}\n\nNTD_SERVICE_RAW &lt;- read_csv(NTD_SERVICE_FILE)\n\n\n\n\nCode\n#clean up the service data\nNTD_SERVICE &lt;- NTD_SERVICE_RAW |&gt;\n    mutate(`NTD ID` = as.numeric(`_5_digit_ntd_id`)) |&gt; \n    rename(Agency = agency, \n           City   = max_city, \n           State  = max_state,\n           UPT    = sum_unlinked_passenger_trips_upt, \n           MILES  = sum_passenger_miles) |&gt;\n    select(matches(\"^[A-Z]\", ignore.case=FALSE)) |&gt;\n    filter(MILES &gt; 0)"
  },
  {
    "objectID": "mp02.html#explore-ntd-service-data",
    "href": "mp02.html#explore-ntd-service-data",
    "title": "Environmental Efficiency of US Public Transit Systems",
    "section": "4 Explore NTD Service Data",
    "text": "4 Explore NTD Service Data\n\n\nCode\n# Which transit service has the most UPT annually?\nlibrary(knitr)\n\nmost_upt &lt;- NTD_SERVICE |&gt;\n  mutate(UPT = comma(UPT)) |&gt;\n  slice_max(UPT, n = 1)\n\nkable(most_upt, caption = \"Transit Service with the Most UPT Annually\")\n\n\n\nTransit Service with the Most UPT Annually\n\n\n\n\n\n\n\n\n\n\nAgency\nCity\nState\nUPT\nMILES\nNTD ID\n\n\n\n\nRockford Mass Transit District\nRockford\nIL\n994,754\n5035893\n50058\n\n\n\n\n\n\n\nCode\n# What is the average trip length of a trip on MTA NYC?\nmta_avg_trip &lt;- NTD_SERVICE |&gt;\n  filter(Agency == \"MTA New York City Transit\") |&gt;\n  mutate(`MTA Average Trip Length` = MILES / UPT) |&gt;\n  select(`NTD ID`, Agency, City, State, `MTA Average Trip Length`)\n\nkable(mta_avg_trip, caption = \"Average Trip Length on MTA NYC\")\n\n\n\nAverage Trip Length on MTA NYC\n\n\n\n\n\n\n\n\n\nNTD ID\nAgency\nCity\nState\nMTA Average Trip Length\n\n\n\n\n20008\nMTA New York City Transit\nBrooklyn\nNY\n3.644089\n\n\n\n\n\n\n\nCode\n# Which transit service in NYC has the longest average trip length?\nnyc_longest_trip &lt;- NTD_SERVICE |&gt;\n  filter(State == \"NY\", City == \"New York\" | City == \"Brooklyn\") |&gt;\n  mutate(`Average Trip Length` = MILES / UPT) |&gt;\n  slice_max(`Average Trip Length`, n = 1)\n\nkable(nyc_longest_trip, caption = \"Transit Service in NYC with the Longest Average Trip Length\")\n\n\n\nTransit Service in NYC with the Longest Average Trip Length\n\n\n\n\n\n\n\n\n\n\n\nAgency\nCity\nState\nUPT\nMILES\nNTD ID\nAverage Trip Length\n\n\n\n\nMTA Long Island Rail Road\nNew York\nNY\n83835706\n2033685836\n20100\n24.25799\n\n\n\n\n\n\n\nCode\n# Which state has the fewest total miles travelled by public transit?\nstate_fewest_miles &lt;- NTD_SERVICE |&gt;\n  group_by(State) |&gt;\n  summarize(`Total Miles` = comma(sum(MILES, na.rm = TRUE))) |&gt;\n  slice_min(`Total Miles`, n = 1)\n\nkable(state_fewest_miles, caption = \"State with the Fewest Total Miles Travelled by Public Transit\")\n\n\n\nState with the Fewest Total Miles Travelled by Public Transit\n\n\nState\nTotal Miles\n\n\n\n\nWA\n1,059,910,614\n\n\n\n\n\n\n\nCode\n# Are all states represented in this data? If no, which ones are missing? The state.name and state.abb objects we used above may be useful here.\nstates_missing &lt;- EIA_SEP_REPORT |&gt;\n  anti_join(NTD_SERVICE, join_by(\"abbreviation\" == \"State\")) |&gt;\n  rename(`Missing States` = state) |&gt;\n  select(`Missing States`)\n\nkable(states_missing, caption = \"Missing States\")\n\n\n\nMissing States\n\n\nMissing States\n\n\n\n\nArizona\n\n\nArkansas\n\n\nCalifornia\n\n\nColorado\n\n\nHawaii\n\n\nIowa\n\n\nKansas\n\n\nLouisiana\n\n\nMissouri\n\n\nMontana\n\n\nNebraska\n\n\nNevada\n\n\nNew Mexico\n\n\nNorth Dakota\n\n\nOklahoma\n\n\nSouth Dakota\n\n\nTexas\n\n\nUtah\n\n\nWyoming"
  },
  {
    "objectID": "mp02.html#analysis",
    "href": "mp02.html#analysis",
    "title": "Environmental Efficiency of US Public Transit Systems",
    "section": "5 Analysis",
    "text": "5 Analysis\nWe’re now ready to start putting these datasets together and using them to identify America’s greenest transit agencies.\n\n\nCode\n# Task 5: join the three tables\nagency_mode_pair &lt;- NTD_SERVICE |&gt;\n  inner_join(NTD_ENERGY |&gt;\n      select(-c(`Kerosene`, `Bunker Fuel`, `Ethanol`, `Methonal`)), #clean it up \n    join_by(\"NTD ID\" == \"NTD ID\")\n    ) |&gt; \n  inner_join(EIA_SEP_REPORT,\n    join_by(State == \"abbreviation\")\n    ) |&gt;\n  select(-c(`Agency Name`, State)) |&gt;\n  rename(\n    agency = `Agency`,\n    city = `City`,\n    mode = `Mode`,\n    upt = `UPT`,\n    miles = `MILES`,\n    ntd_id = `NTD ID`,\n    biodiesel = `Bio-Diesel`,\n    cnaturalgas = `C Natural Gas`,\n    diesel = `Diesel Fuel`,\n    gasoline = `Gasoline`,\n    liqnatgas = `Liquified Nat Gas`,\n    liqpetgas =`Liquified Petroleum Gas`,\n    electric_battery = `Electric Battery`,\n    electric_propulsion = `Electric Propulsion`,\n    co2_mwh = CO2_MWh\n    ) |&gt;\n  mutate(\n    electricbattery_emission = electric_battery * (co2_mwh / 1000),\n    electricprop_emission = electric_propulsion * (co2_mwh / 1000),\n    total_emission = (\n        electricbattery_emission +\n        electricprop_emission\n      )\n  ) |&gt;\n  group_by(ntd_id) |&gt;\n  mutate(agency_total_emission = sum(total_emission)) |&gt;\n  ungroup()\n\n# Task 6\n# use percentiles to define small, medium, and large agencies. \npercentile_1 &lt;- quantile(agency_mode_pair |&gt; select(upt) |&gt; unique() |&gt; pull(upt), 0.3)\npercentile_2 &lt;- quantile(agency_mode_pair |&gt; select(upt) |&gt; unique() |&gt; pull(upt), 0.7)\n\n# updating agency_mode_pair with agency size\n# adding green level\nagency_mode_pair &lt;-\n  agency_mode_pair |&gt;\n  group_by(ntd_id) |&gt;\n  mutate(\n    agency_emission_per_capita = sum(total_emission) / upt,\n    emission_per_transit = sum(total_emission) / miles,\n    green_level = agency_emission_per_capita * emission_per_transit,\n    size = case_when(\n      upt &lt; percentile_1 ~ \"Small\",\n      upt &gt;= percentile_1 & upt &lt;= percentile_2 ~ \"Medium\",\n      upt &gt; percentile_2 ~ \"Large\",\n    )\n    ) |&gt;\n  ungroup()\n\n\nBesed on our analysis, the Greenest Transit Agency award goes to King County Metro for large size, it goes to Everett Transist for medium size, and it goes to RiverCities Transit for small size.\n\n\nCode\n# grouping th data\ngreen_levels &lt;-\n  agency_mode_pair |&gt;\n  group_by(size, ntd_id) |&gt;\n  summarize(\n    agency = first(agency),\n    city = first(city),\n    state = first(state),\n    green_level = first(green_level),\n    .groups = 'drop'\n  ) |&gt;\n  ungroup()\n\n# Select the greenest agency in each size\ngreenest_agency &lt;-\n  green_levels |&gt;\n  group_by(size) |&gt;\n  slice(1) |&gt;\n  select(agency, city, state)\n\n# Compute median green\nmedian_green &lt;- green_levels |&gt;\n  group_by(size) |&gt;\n  summarise(median_green = median(green_level, na.rm = TRUE))\n\n# visualize greenest agenciies\ngreenest_agency |&gt;\n  left_join(median_green, join_by(\"size\" == \"size\")) |&gt;\n  select(agency, city, state) |&gt;\n  kable(caption = \"Greenest Transit Agency\")\n\n\n\nGreenest Transit Agency\n\n\n\n\n\n\n\n\nsize\nagency\ncity\nstate\n\n\n\n\nLarge\nKing County, dba: King County Metro\nSeattle\nWashington\n\n\nMedium\nCity of Everett, dba: Everett Transit\nEverett\nWashington\n\n\nSmall\nCity of Longview, dba: RiverCities Transit\nLongview\nWashington"
  },
  {
    "objectID": "mp02.html#introduction",
    "href": "mp02.html#introduction",
    "title": "Environmental Efficiency of US Public Transit Systems",
    "section": "",
    "text": "Green Transit Alliance for Investigation of Variance (GTA IV) gave a series of awards for the greenest public transit angencies. The winners of the various GTA IV awards went to King County Metro, Everett Transit and RiverCities Transit. We will explore US Public Transit systems to assess their environmental efficiency and will use a variety of data sources to i) determine how many riders are served by different transit systems; ii) determine how far each public transit system transports an average rider; and iii) investigate the effective emissions associated with each form of transit."
  },
  {
    "objectID": "mp02_v1.html",
    "href": "mp02_v1.html",
    "title": "Environmental Efficiency of US Public Transit Systems",
    "section": "",
    "text": "Green Transit Alliance for Investigation of Variance (GTA IV) gave a series of awards for the greenest public transit angencies. The winners of the various GTA IV awards went to King County Metro, Everett Transit and RiverCities Transit. We will explore US Public Transit systems to assess their environmental efficiency and will use a variety of data sources to i) determine how many riders are served by different transit systems; ii) determine how far each public transit system transports an average rider; and iii) investigate the effective emissions associated with each form of transit."
  },
  {
    "objectID": "mp02_v1.html#introduction",
    "href": "mp02_v1.html#introduction",
    "title": "Environmental Efficiency of US Public Transit Systems",
    "section": "",
    "text": "Green Transit Alliance for Investigation of Variance (GTA IV) gave a series of awards for the greenest public transit angencies. The winners of the various GTA IV awards went to King County Metro, Everett Transit and RiverCities Transit. We will explore US Public Transit systems to assess their environmental efficiency and will use a variety of data sources to i) determine how many riders are served by different transit systems; ii) determine how far each public transit system transports an average rider; and iii) investigate the effective emissions associated with each form of transit."
  },
  {
    "objectID": "mp02_v1.html#data-import",
    "href": "mp02_v1.html#data-import",
    "title": "Environmental Efficiency of US Public Transit Systems",
    "section": "2 Data Import",
    "text": "2 Data Import\nWe download the EIA State Electricity Profiles, then use it to estimate the environmental impact of the electricity used to run certain transit systems.\n\n\nCode\nensure_package &lt;- function(pkg){\n    pkg &lt;- as.character(substitute(pkg))\n    options(repos = c(CRAN = \"https://cloud.r-project.org\"))\n    if(!require(pkg, character.only=TRUE)) install.packages(pkg)\n    stopifnot(require(pkg, character.only=TRUE))\n}\n\nensure_package(httr2)\nensure_package(rvest)\nensure_package(datasets)\nensure_package(purrr)\nensure_package(DT)\nensure_package(stringr)\nensure_package(dplyr)\n\nget_eia_sep &lt;- function(state, abbr){\n    state_formatted &lt;- str_to_lower(state) |&gt; str_replace_all(\"\\\\s\", \"\")\n    \n    dir_name &lt;- file.path(\"data\", \"mp02\")\n    file_name &lt;- file.path(dir_name, state_formatted)\n    \n    dir.create(dir_name, showWarnings=FALSE, recursive=TRUE)\n    \n    if(!file.exists(file_name)){\n        BASE_URL &lt;- \"https://www.eia.gov\"\n        REQUEST &lt;- request(BASE_URL) |&gt; \n            req_url_path(\"electricity\", \"state\", state_formatted)\n    \n        RESPONSE &lt;- req_perform(REQUEST)\n    \n        resp_check_status(RESPONSE)\n        \n        writeLines(resp_body_string(RESPONSE), file_name)\n    }\n    \n    TABLE &lt;- read_html(file_name) |&gt; \n        html_element(\"table\") |&gt; \n        html_table() |&gt;\n        mutate(Item = str_to_lower(Item))\n    \n    if(\"U.S. rank\" %in% colnames(TABLE)){\n        TABLE &lt;- TABLE |&gt; rename(Rank = `U.S. rank`)\n    }\n    \n    CO2_MWh &lt;- TABLE |&gt; \n        filter(Item == \"carbon dioxide (lbs/mwh)\") |&gt;\n        pull(Value) |&gt; \n        str_replace_all(\",\", \"\") |&gt;\n        as.numeric()\n    \n    PRIMARY &lt;- TABLE |&gt; \n        filter(Item == \"primary energy source\") |&gt; \n        pull(Rank)\n    \n    RATE &lt;- TABLE |&gt;\n        filter(Item == \"average retail price (cents/kwh)\") |&gt;\n        pull(Value) |&gt;\n        as.numeric()\n    \n    GENERATION_MWh &lt;- TABLE |&gt;\n        filter(Item == \"net generation (megawatthours)\") |&gt;\n        pull(Value) |&gt;\n        str_replace_all(\",\", \"\") |&gt;\n        as.numeric()\n    \n    data.frame(CO2_MWh               = CO2_MWh, \n               primary_source        = PRIMARY,\n               electricity_price_MWh = RATE * 10, # / 100 cents to dollars &\n               # * 1000 kWh to MWH \n               generation_MWh        = GENERATION_MWh, \n               state                 = state, \n               abbreviation          = abbr\n    )\n}\n\nEIA_SEP_REPORT &lt;- map2(state.name, state.abb, get_eia_sep) |&gt; list_rbind()\n\n\nWe use the following code to create a table.\n\n\nCode\nensure_package(scales)\n\nEIA_SEP_REPORT |&gt; \n    select(-abbreviation) |&gt;\n    arrange(desc(CO2_MWh)) |&gt;\n    mutate(CO2_MWh = number(CO2_MWh, big.mark=\",\"), \n           electricity_price_MWh = dollar(electricity_price_MWh), \n           generation_MWh = number(generation_MWh, big.mark=\",\")) |&gt;\n    rename(`Pounds of CO2 Emitted per MWh of Electricity Produced`=CO2_MWh, \n           `Primary Source of Electricity Generation`=primary_source, \n           `Average Retail Price for 1000 kWh`=electricity_price_MWh, \n           `Total Generation Capacity (MWh)`= generation_MWh, \n           State=state) |&gt;\n    datatable()"
  },
  {
    "objectID": "mp02_v1.html#initial-analysis-of-sep-data",
    "href": "mp02_v1.html#initial-analysis-of-sep-data",
    "title": "Environmental Efficiency of US Public Transit Systems",
    "section": "3 Initial Analysis of SEP Data",
    "text": "3 Initial Analysis of SEP Data\nHere are some quick facts gained using the EIA_SEP_REPORT data.\n\nHawaii has the most expensive retail electricity with a price of $386 per MWh.\n\n\n\nCode\n# Which state has the most expensive retail electricity?\nstate_highest_price &lt;- EIA_SEP_REPORT |&gt;\n  select(electricity_price_MWh, state) |&gt;\n  slice_max(electricity_price_MWh, n=1)\n\n\n\nWest Virginia, whose primary source of electricity generation is coal, has the ‘dirtiest’ electricity mix with 1925 pounds of CO2 emitted per MWh.\n\n\n\nCode\n# Which state has the 'dirtiest' electricity mix?\nstate_dirtiest_electricity &lt;- EIA_SEP_REPORT |&gt;\n  select(CO2_MWh, primary_source, state) |&gt;\n  slice_max(CO2_MWh, n=1)\n\n\n\nOn average, 805.37 pounds of CO2 are emitted per MWh of electricity produced in the US.\n\n\n\nCode\n# On average, how many pounds of CO2 are emitted per MWh of electricity produced in the US? (Note that you will need to use a suitably weighted average here.)\naverage_co2_emitted &lt;- EIA_SEP_REPORT |&gt;\n  summarize(\n    average_co2 = sum(CO2_MWh * generation_MWh) / sum(generation_MWh)\n  )\n\n\n\nPetroleum is the rarest primary energy source in the US used only in one state. The associated cost of electricity is $386 per MWh and it is used in Hawaii.\n\n\n\nCode\n# What is the rarest primary energy source in the US? \nrarest_source &lt;- EIA_SEP_REPORT |&gt;\n  group_by(primary_source) |&gt;\n  summarize(num_state_source = n()) |&gt;\n  slice_min(num_state_source, n = 1)\n\n# What is the associated cost of electricity and where is it used?\nrarest_source_table &lt;- EIA_SEP_REPORT |&gt;\n  select(primary_source, electricity_price_MWh, state) |&gt;\n  filter(primary_source == \"Petroleum\")\n\n\n\nNY’s energy mix is 1.64 times cleaner than that of Texas.\n\n\n\nCode\n# How many times cleaner is NY’s energy mix than that of Texas?\nco2_emitted_NY &lt;- EIA_SEP_REPORT |&gt;\n  filter(state == \"New York\") |&gt;\n  summarize(CO2_MWh)\n\nco2_emitted_Texas &lt;- EIA_SEP_REPORT |&gt;\n  filter(state == \"Texas\") |&gt;\n  summarize(CO2_MWh)\n\ntimes_cleaner &lt;- co2_emitted_Texas / co2_emitted_NY\n\n\nWe now download the 2023 Annual Database Energy Consumption report and do some clean up. After that, we recode the Mode column.\n\n\nCode\n# import the data: 2023 Annual Database Energy Consumption\nensure_package(readxl)\n# Create 'data/mp02' directory if not already present\nDATA_DIR &lt;- file.path(\"data\", \"mp02\")\ndir.create(DATA_DIR, showWarnings=FALSE, recursive=TRUE)\n\nNTD_ENERGY_FILE &lt;- file.path(DATA_DIR, \"2023_ntd_energy.xlsx\")\n\nif(!file.exists(NTD_ENERGY_FILE)){\n    DS &lt;- download.file(\"https://www.transit.dot.gov/sites/fta.dot.gov/files/2024-10/2023%20Energy%20Consumption.xlsx\", \n                  destfile=NTD_ENERGY_FILE, \n                  method=\"curl\")\n    \n    if(DS | (file.info(NTD_ENERGY_FILE)$size == 0)){\n        cat(\"I was unable to download the NTD Energy File. Please try again.\\n\")\n        stop(\"Download failed\")\n    }\n}\n\nNTD_ENERGY_RAW &lt;- read_xlsx(NTD_ENERGY_FILE)\n\n\n\n\nCode\n# do some basic clean-up\nensure_package(tidyr)\nto_numeric_fill_0 &lt;- function(x){\n    replace_na(as.numeric(x), 0)\n}\n\nNTD_ENERGY &lt;- NTD_ENERGY_RAW |&gt; \n    select(-c(`Reporter Type`, \n              `Reporting Module`, \n              `Other Fuel`, \n              `Other Fuel Description`)) |&gt;\n    mutate(across(-c(`Agency Name`, \n                     `Mode`,\n                     `TOS`), \n                  to_numeric_fill_0)) |&gt;\n    group_by(`NTD ID`, `Mode`, `Agency Name`) |&gt;\n    summarize(across(where(is.numeric), sum), \n              .groups = \"keep\") |&gt;\n    mutate(ENERGY = sum(c_across(c(where(is.numeric))))) |&gt;\n    filter(ENERGY &gt; 0) |&gt;\n    select(-ENERGY) |&gt;\n    ungroup()\n\n\n\n\nCode\n# clean up mode column in ntd energy\nNTD_ENERGY &lt;- NTD_ENERGY |&gt;\n    mutate(Mode=case_when(\n        Mode == \"HR\" ~ \"Heavy Rail\",\n        Mode == \"AR\" ~ \"Alaska Railroad\",\n        Mode == \"CB\" ~ \"Commuter Bus\",\n        Mode == \"CC\" ~ \"Cable Car\",\n        Mode == \"CR\" ~ \"Commuter Rail\",\n        Mode == \"DR\" ~ \"Demand Response\",\n        Mode == \"FB\" ~ \"Ferryboat\",\n        Mode == \"IP\" ~ \"Inclined Plane\",\n        Mode == \"LR\" ~ \"Light Rail\",\n        Mode == \"MB\" ~ \"Bus\",\n        Mode == \"MG\" ~ \"Monorail and Automated Guideway modes\",\n        Mode == \"PB\" ~ \"Publico\",\n        Mode == \"RB\" ~ \"Bus Rapid Transit\",\n        Mode == \"SR\" ~ \"Streetcar Rail\",\n        Mode == \"TB\" ~ \"Trolleybus\",\n        Mode == \"TR\" ~ \"Aerial Tramways\",\n        Mode == \"VP\" ~ \"Vanpool\",\n        Mode == \"YR\" ~ \"Hybrid Rail\",\n        TRUE ~ \"Unknown\"))\n\n\nNext, we download the 2023 Service by Agency report, from which we will extract characteristics of typical passenger trips on each transit service. We will also explore the data by answering some questions using the service data.\n\n\nCode\n# download the 2023 service by agency report\nlibrary(readr)\nNTD_SERVICE_FILE &lt;- file.path(DATA_DIR, \"2023_service.csv\")\nif(!file.exists(NTD_SERVICE_FILE)){\n    DS &lt;- download.file(\"https://data.transportation.gov/resource/6y83-7vuw.csv\", \n                  destfile=NTD_SERVICE_FILE, \n                  method=\"curl\")\n    \n    if(DS | (file.info(NTD_SERVICE_FILE)$size == 0)){\n        cat(\"I was unable to download the NTD Service File. Please try again.\\n\")\n        stop(\"Download failed\")\n    }\n}\n\nNTD_SERVICE_RAW &lt;- read_csv(NTD_SERVICE_FILE)\n\n\n\n\nCode\n#clean up the service data\nNTD_SERVICE &lt;- NTD_SERVICE_RAW |&gt;\n    mutate(`NTD ID` = as.numeric(`_5_digit_ntd_id`)) |&gt; \n    rename(Agency = agency, \n           City   = max_city, \n           State  = max_state,\n           UPT    = sum_unlinked_passenger_trips_upt, \n           MILES  = sum_passenger_miles) |&gt;\n    select(matches(\"^[A-Z]\", ignore.case=FALSE)) |&gt;\n    filter(MILES &gt; 0)"
  },
  {
    "objectID": "mp02_v1.html#explore-ntd-service-data",
    "href": "mp02_v1.html#explore-ntd-service-data",
    "title": "Environmental Efficiency of US Public Transit Systems",
    "section": "4 Explore NTD Service Data",
    "text": "4 Explore NTD Service Data\n\n\nCode\n# Which transit service has the most UPT annually?\nlibrary(knitr)\n\nmost_upt &lt;- NTD_SERVICE |&gt;\n  mutate(UPT = comma(UPT)) |&gt;\n  slice_max(UPT, n = 1)\n\nkable(most_upt, caption = \"Transit Service with the Most UPT Annually\")\n\n\n\nTransit Service with the Most UPT Annually\n\n\n\n\n\n\n\n\n\n\nAgency\nCity\nState\nUPT\nMILES\nNTD ID\n\n\n\n\nRockford Mass Transit District\nRockford\nIL\n994,754\n5035893\n50058\n\n\n\n\n\n\n\nCode\n# What is the average trip length of a trip on MTA NYC?\nmta_avg_trip &lt;- NTD_SERVICE |&gt;\n  filter(Agency == \"MTA New York City Transit\") |&gt;\n  mutate(`MTA Average Trip Length` = MILES / UPT) |&gt;\n  select(`NTD ID`, Agency, City, State, `MTA Average Trip Length`)\n\nkable(mta_avg_trip, caption = \"Average Trip Length on MTA NYC\")\n\n\n\nAverage Trip Length on MTA NYC\n\n\n\n\n\n\n\n\n\nNTD ID\nAgency\nCity\nState\nMTA Average Trip Length\n\n\n\n\n20008\nMTA New York City Transit\nBrooklyn\nNY\n3.644089\n\n\n\n\n\n\n\nCode\n# Which transit service in NYC has the longest average trip length?\nnyc_longest_trip &lt;- NTD_SERVICE |&gt;\n  filter(State == \"NY\", City == \"New York\" | City == \"Brooklyn\") |&gt;\n  mutate(`Average Trip Length` = MILES / UPT) |&gt;\n  slice_max(`Average Trip Length`, n = 1)\n\nkable(nyc_longest_trip, caption = \"Transit Service in NYC with the Longest Average Trip Length\")\n\n\n\nTransit Service in NYC with the Longest Average Trip Length\n\n\n\n\n\n\n\n\n\n\n\nAgency\nCity\nState\nUPT\nMILES\nNTD ID\nAverage Trip Length\n\n\n\n\nMTA Long Island Rail Road\nNew York\nNY\n83835706\n2033685836\n20100\n24.25799\n\n\n\n\n\n\n\nCode\n# Which state has the fewest total miles travelled by public transit?\nstate_fewest_miles &lt;- NTD_SERVICE |&gt;\n  group_by(State) |&gt;\n  summarize(`Total Miles` = comma(sum(MILES, na.rm = TRUE))) |&gt;\n  slice_min(`Total Miles`, n = 1)\n\nkable(state_fewest_miles, caption = \"State with the Fewest Total Miles Travelled by Public Transit\")\n\n\n\nState with the Fewest Total Miles Travelled by Public Transit\n\n\nState\nTotal Miles\n\n\n\n\nWA\n1,059,910,614\n\n\n\n\n\n\n\nCode\n# Are all states represented in this data? If no, which ones are missing? The state.name and state.abb objects we used above may be useful here.\nstates_missing &lt;- EIA_SEP_REPORT |&gt;\n  anti_join(NTD_SERVICE, join_by(\"abbreviation\" == \"State\")) |&gt;\n  rename(`Missing States` = state) |&gt;\n  select(`Missing States`)\n\nkable(states_missing, caption = \"Missing States\")\n\n\n\nMissing States\n\n\nMissing States\n\n\n\n\nArizona\n\n\nArkansas\n\n\nCalifornia\n\n\nColorado\n\n\nHawaii\n\n\nIowa\n\n\nKansas\n\n\nLouisiana\n\n\nMissouri\n\n\nMontana\n\n\nNebraska\n\n\nNevada\n\n\nNew Mexico\n\n\nNorth Dakota\n\n\nOklahoma\n\n\nSouth Dakota\n\n\nTexas\n\n\nUtah\n\n\nWyoming"
  },
  {
    "objectID": "mp02_v1.html#analysis",
    "href": "mp02_v1.html#analysis",
    "title": "Environmental Efficiency of US Public Transit Systems",
    "section": "5 Analysis",
    "text": "5 Analysis\nWe’re now ready to start putting these datasets together and using them to identify America’s greenest transit agencies.\n\n\nCode\n# Task 5: join the three tables\nagency_mode_pair &lt;- NTD_SERVICE |&gt;\n  inner_join(NTD_ENERGY |&gt;\n      select(-c(`Kerosene`, `Bunker Fuel`, `Ethanol`, `Methonal`)), #clean it up \n    join_by(\"NTD ID\" == \"NTD ID\")\n    ) |&gt; \n  inner_join(EIA_SEP_REPORT,\n    join_by(State == \"abbreviation\")\n    ) |&gt;\n  select(-c(`Agency Name`, State)) |&gt;\n  rename(\n    agency = `Agency`,\n    city = `City`,\n    mode = `Mode`,\n    upt = `UPT`,\n    miles = `MILES`,\n    ntd_id = `NTD ID`,\n    biodiesel = `Bio-Diesel`,\n    cnaturalgas = `C Natural Gas`,\n    diesel = `Diesel Fuel`,\n    gasoline = `Gasoline`,\n    liqnatgas = `Liquified Nat Gas`,\n    liqpetgas =`Liquified Petroleum Gas`,\n    electric_battery = `Electric Battery`,\n    electric_propulsion = `Electric Propulsion`,\n    co2_mwh = CO2_MWh\n    ) |&gt;\n  mutate(\n    electricbattery_emission = electric_battery * (co2_mwh / 1000),\n    electricprop_emission = electric_propulsion * (co2_mwh / 1000),\n    total_emission = (\n        electricbattery_emission +\n        electricprop_emission\n      )\n  ) |&gt;\n  group_by(ntd_id) |&gt;\n  mutate(agency_total_emission = sum(total_emission)) |&gt;\n  ungroup()\n\n# Task 6\n# use percentiles to define small, medium, and large agencies. \npercentile_1 &lt;- quantile(agency_mode_pair |&gt; select(upt) |&gt; unique() |&gt; pull(upt), 0.3)\npercentile_2 &lt;- quantile(agency_mode_pair |&gt; select(upt) |&gt; unique() |&gt; pull(upt), 0.7)\n\n# updating agency_mode_pair with agency size\n# adding green level\nagency_mode_pair &lt;-\n  agency_mode_pair |&gt;\n  group_by(ntd_id) |&gt;\n  mutate(\n    agency_emission_per_capita = sum(total_emission) / upt,\n    emission_per_transit = sum(total_emission) / miles,\n    green_level = agency_emission_per_capita * emission_per_transit,\n    size = case_when(\n      upt &lt; percentile_1 ~ \"Small\",\n      upt &gt;= percentile_1 & upt &lt;= percentile_2 ~ \"Medium\",\n      upt &gt; percentile_2 ~ \"Large\",\n    )\n    ) |&gt;\n  ungroup()\n\n\nBesed on our analysis, the Greenest Transit Agency award goes to King County Metro for large size, it goes to Everett Transist for medium size, and it goes to RiverCities Transit for small size.\n\n\nCode\n# grouping th data\ngreen_levels &lt;-\n  agency_mode_pair |&gt;\n  group_by(size, ntd_id) |&gt;\n  summarize(\n    agency = first(agency),\n    city = first(city),\n    state = first(state),\n    green_level = first(green_level),\n    .groups = 'drop'\n  ) |&gt;\n  ungroup()\n\n# Select the greenest agency in each size\ngreenest_agency &lt;-\n  green_levels |&gt;\n  group_by(size) |&gt;\n  slice(1) |&gt;\n  select(agency, city, state)\n\n# Compute median green\nmedian_green &lt;- green_levels |&gt;\n  group_by(size) |&gt;\n  summarise(median_green = median(green_level, na.rm = TRUE))\n\n# visualize greenest agenciies\ngreenest_agency |&gt;\n  left_join(median_green, join_by(\"size\" == \"size\")) |&gt;\n  select(agency, city, state) |&gt;\n  kable(caption = \"Greenest Transit Agency\")\n\n\n\nGreenest Transit Agency\n\n\n\n\n\n\n\n\nsize\nagency\ncity\nstate\n\n\n\n\nLarge\nKing County, dba: King County Metro\nSeattle\nWashington\n\n\nMedium\nCity of Everett, dba: Everett Transit\nEverett\nWashington\n\n\nSmall\nCity of Longview, dba: RiverCities Transit\nLongview\nWashington"
  },
  {
    "objectID": "mp02_v1.html#conclusion",
    "href": "mp02_v1.html#conclusion",
    "title": "Environmental Efficiency of US Public Transit Systems",
    "section": "6 Conclusion",
    "text": "6 Conclusion\nThis press release announces the winners in each category. The greenest transit for large size agencies is King County Metro, in Seattle, Washington. For medium size agencies, Everett Transit in Everett, Washington is the greenest. The winner for small size agencies goes to RiverCities Transit from Longview, Washington."
  },
  {
    "objectID": "mp02.html#greenest-transit-awards",
    "href": "mp02.html#greenest-transit-awards",
    "title": "2025 ‘Greenest Transit’ Awards Go to…",
    "section": "",
    "text": "This year’s Greenest Transit results just came out. The greeest transit agency awards have three categories: Large, Medium and Small, in terms of the sizes of agencies. Now, Let’s announce who the winners are! The greenest agencies are respectively MTA NYC Transit, Birmingham-Jefferson County Transit Authority, and Albany Transit System. The agencies with most emissions avoided are MTA New York City Transit, Hudson Transit Lines, and Hampton Jitney. The agencies with the highest electirfication level are TriMet, University of Georgia, and Connecticut Department of Transportation. We also have “winners” for the worst performance in terms of green and they are Washington State Ferries, SeaStreak, and Alaska Railroad Corporation. The relevent metrics with their values can be found in the appendix. To better demonstrate the ‘green-ness’ of the award winners, we have created some visualizations."
  },
  {
    "objectID": "mp02.html#appendix",
    "href": "mp02.html#appendix",
    "title": "2025 ‘Greenest Transit’ Awards Go to…",
    "section": "2 Appendix",
    "text": "2 Appendix\n\n\nCode\nensure_package &lt;- function(pkg){\n    pkg &lt;- as.character(substitute(pkg))\n    options(repos = c(CRAN = \"https://cloud.r-project.org\"))\n    if(!require(pkg, character.only=TRUE)) install.packages(pkg)\n    stopifnot(require(pkg, character.only=TRUE))\n}\n\nensure_package(dplyr)\nensure_package(stringr)\nensure_package(tidyr)\nensure_package(httr2)\nensure_package(rvest)\nensure_package(datasets)\nensure_package(purrr)\nensure_package(DT)\n\nget_eia_sep &lt;- function(state, abbr){\n    state_formatted &lt;- str_to_lower(state) |&gt; str_replace_all(\"\\\\s\", \"\")\n    \n    dir_name &lt;- file.path(\"data\", \"mp02\")\n    file_name &lt;- file.path(dir_name, state_formatted)\n    \n    dir.create(dir_name, showWarnings=FALSE, recursive=TRUE)\n    \n    if(!file.exists(file_name)){\n        BASE_URL &lt;- \"https://www.eia.gov\"\n        REQUEST &lt;- request(BASE_URL) |&gt; \n            req_url_path(\"electricity\", \"state\", state_formatted)\n    \n        RESPONSE &lt;- req_perform(REQUEST)\n    \n        resp_check_status(RESPONSE)\n        \n        writeLines(resp_body_string(RESPONSE), file_name)\n    }\n    \n    TABLE &lt;- read_html(file_name) |&gt; \n        html_element(\"table\") |&gt; \n        html_table() |&gt;\n        mutate(Item = str_to_lower(Item))\n    \n    if(\"U.S. rank\" %in% colnames(TABLE)){\n        TABLE &lt;- TABLE |&gt; rename(Rank = `U.S. rank`)\n    }\n    \n    CO2_MWh &lt;- TABLE |&gt; \n        filter(Item == \"carbon dioxide (lbs/mwh)\") |&gt;\n        pull(Value) |&gt; \n        str_replace_all(\",\", \"\") |&gt;\n        as.numeric()\n    \n    PRIMARY &lt;- TABLE |&gt; \n        filter(Item == \"primary energy source\") |&gt; \n        pull(Rank)\n    \n    RATE &lt;- TABLE |&gt;\n        filter(Item == \"average retail price (cents/kwh)\") |&gt;\n        pull(Value) |&gt;\n        as.numeric()\n    \n    GENERATION_MWh &lt;- TABLE |&gt;\n        filter(Item == \"net generation (megawatthours)\") |&gt;\n        pull(Value) |&gt;\n        str_replace_all(\",\", \"\") |&gt;\n        as.numeric()\n    \n    data.frame(CO2_MWh               = CO2_MWh, \n               primary_source        = PRIMARY,\n               electricity_price_MWh = RATE * 10, # / 100 cents to dollars &\n               # * 1000 kWh to MWH \n               generation_MWh        = GENERATION_MWh, \n               state                 = state, \n               abbreviation          = abbr\n    )\n}\n\nEIA_SEP_REPORT &lt;- map2(state.name, state.abb, get_eia_sep) |&gt; list_rbind()\n\nensure_package(scales)\nensure_package(DT)\n\nlibrary(knitr)\n# Which state has the most expensive retail electricity?\nstate_most_expensive &lt;- EIA_SEP_REPORT |&gt;\n  slice_max(electricity_price_MWh, n = 1) |&gt;\n  mutate(CO2_MWh = number(CO2_MWh, big.mark=\",\"), \n         electricity_price_MWh = dollar(electricity_price_MWh), \n         generation_MWh = number(generation_MWh, big.mark=\",\")) |&gt;\n  rename(`Pounds of CO2 Emitted per MWh of Electricity Produced`=CO2_MWh, \n         `Primary Source of Electricity Generation`=primary_source, \n         `Average Retail Price for 1000 kWh`=electricity_price_MWh, \n         `Total Generation Capacity (MWh)`= generation_MWh, \n         State=state)\nkable(state_most_expensive, caption = \"State with the Most Expensive Retail Electricity\")\n\n\n\nState with the Most Expensive Retail Electricity\n\n\n\n\n\n\n\n\n\n\nPounds of CO2 Emitted per MWh of Electricity Produced\nPrimary Source of Electricity Generation\nAverage Retail Price for 1000 kWh\nTotal Generation Capacity (MWh)\nState\nabbreviation\n\n\n\n\n1,444\nPetroleum\n$386\n9,194,164\nHawaii\nHI\n\n\n\n\n\nCode\n# Which state has the ‘dirtiest’ electricity mix?\nstate_dirtiest &lt;- EIA_SEP_REPORT |&gt;\n  slice_max(CO2_MWh, n = 1) |&gt;\n  mutate(CO2_MWh = number(CO2_MWh, big.mark=\",\"), \n         electricity_price_MWh = dollar(electricity_price_MWh), \n         generation_MWh = number(generation_MWh, big.mark=\",\")) |&gt;\n  rename(`Pounds of CO2 Emitted per MWh of Electricity Produced`=CO2_MWh, \n         `Primary Source of Electricity Generation`=primary_source, \n         `Average Retail Price for 1000 kWh`=electricity_price_MWh, \n         `Total Generation Capacity (MWh)`= generation_MWh, \n         State=state)\nkable(state_dirtiest, caption = \"State with the 'Dirtiest' Electricity Mix\")\n\n\n\nState with the ‘Dirtiest’ Electricity Mix\n\n\n\n\n\n\n\n\n\n\nPounds of CO2 Emitted per MWh of Electricity Produced\nPrimary Source of Electricity Generation\nAverage Retail Price for 1000 kWh\nTotal Generation Capacity (MWh)\nState\nabbreviation\n\n\n\n\n1,925\nCoal\n$102.60\n52,286,784\nWest Virginia\nWV\n\n\n\n\n\nCode\n# On average, how many pounds of CO2 are emitted per MWh of electricity produced in the US?\navg_co2 &lt;- EIA_SEP_REPORT |&gt;\n  summarize(avg_co2 = sum(CO2_MWh * generation_MWh) / sum(generation_MWh)) |&gt;\n  mutate(avg_co2= number(avg_co2, big.mark = \",\")) |&gt;\n  rename(`Average CO2 emissions per MWh`=avg_co2)\nkable(avg_co2, caption = \"Average CO2 Emissions per MWh in the US\")\n\n\n\nAverage CO2 Emissions per MWh in the US\n\n\nAverage CO2 emissions per MWh\n\n\n\n\n805\n\n\n\n\n\nCode\n# What is the rarest primary energy source in the US?\nrarest_source &lt;- EIA_SEP_REPORT |&gt;\n  group_by(primary_source) |&gt;\n  summarize(Number = n()) |&gt;\n  slice_min(Number, n = 1) |&gt;\n  pull(primary_source)\n# What is the associated cost of electricity and where is it used?\nrarest &lt;- EIA_SEP_REPORT |&gt;\n  filter(primary_source==rarest_source) |&gt;\n  select(primary_source, electricity_price_MWh, state) |&gt;\n  mutate(electricity_price_MWh = dollar(electricity_price_MWh)) |&gt;\n  rename(`Primary Source of Electricity Generation`=primary_source, \n         `Average Retail Price for 1000 kWh`=electricity_price_MWh, \n         State=state)\nkable(rarest, caption =\"Rarest Source and Its Cost and Location\")\n\n\n\nRarest Source and Its Cost and Location\n\n\n\n\n\n\n\nPrimary Source of Electricity Generation\nAverage Retail Price for 1000 kWh\nState\n\n\n\n\nPetroleum\n$386\nHawaii\n\n\n\n\n\nCode\n# My home state, Texas, has a reputation as being the home of “dirty fossil fuels” \n# while NY has a reputation as a leader in clean energy. How many times cleaner is \n# NY’s energy mix than that of Texas?\nco2_ny &lt;- EIA_SEP_REPORT |&gt;\n  filter(state == \"New York\") |&gt;\n  pull(CO2_MWh)\nco2_tx &lt;- EIA_SEP_REPORT |&gt;\n  filter(state == \"Texas\") |&gt;\n  pull(CO2_MWh)\ntimes_cleaner &lt;- EIA_SEP_REPORT |&gt;\n  filter(state %in% c(\"New York\",\"Texas\")) |&gt;\n  mutate(times = CO2_MWh / co2_ny) |&gt;\n  select(state, primary_source, CO2_MWh, times) |&gt;\n  rename(`Pounds of CO2 Emitted per MWh of Electricity Produced`=CO2_MWh, \n         `Primary Source of Electricity Generation`=primary_source, \n         `New York is Cleaner than this State with Times`=times,\n         State=state)\nkable(times_cleaner,caption=\"New York is cleaner than Texas\")\n\n\n\nNew York is cleaner than Texas\n\n\n\n\n\n\n\n\nState\nPrimary Source of Electricity Generation\nPounds of CO2 Emitted per MWh of Electricity Produced\nNew York is Cleaner than this State with Times\n\n\n\n\nNew York\nNatural gas\n522\n1.000000\n\n\nTexas\nNatural gas\n855\n1.637931\n\n\n\n\n\nCode\n# 2023 ntd energy\nensure_package(readxl)\n# Create 'data/mp02' directory if not already present\nDATA_DIR &lt;- file.path(\"data\", \"mp02\")\ndir.create(DATA_DIR, showWarnings=FALSE, recursive=TRUE)\n\nNTD_ENERGY_FILE &lt;- file.path(DATA_DIR, \"2023_ntd_energy.xlsx\")\n\nif(!file.exists(NTD_ENERGY_FILE)){\n  DS &lt;- download.file(\"https://www.transit.dot.gov/sites/fta.dot.gov/files/2024-10/2023%20Energy%20Consumption.xlsx\", \n                      destfile=NTD_ENERGY_FILE, \n                      method=\"curl\")\n  \n  if(DS | (file.info(NTD_ENERGY_FILE)$size == 0)){\n    cat(\"I was unable to download the NTD Energy File. Please try again.\\n\")\n    stop(\"Download failed\")\n  }\n}\n\nNTD_ENERGY_RAW &lt;- read_xlsx(NTD_ENERGY_FILE)\n\n# basic clean up\nensure_package(tidyr)\nto_numeric_fill_0 &lt;- function(x){\n  x &lt;- if_else(x == \"-\", NA, x)\n  replace_na(as.numeric(x), 0)\n}\n\nNTD_ENERGY &lt;- NTD_ENERGY_RAW |&gt; \n  select(-c(`Reporter Type`, \n            `Reporting Module`, \n            `Other Fuel`, \n            `Other Fuel Description`)) |&gt;\n  mutate(across(-c(`Agency Name`, \n                   `Mode`,\n                   `TOS`), \n                to_numeric_fill_0)) |&gt;\n  group_by(`NTD ID`, `Mode`, `Agency Name`) |&gt;\n  summarize(across(where(is.numeric), sum), \n            .groups = \"keep\") |&gt;\n  mutate(ENERGY = sum(c_across(c(where(is.numeric))))) |&gt;\n  filter(ENERGY &gt; 0) |&gt;\n  select(-ENERGY) |&gt;\n  ungroup()\n\n## This code needs to be modified\nNTD_ENERGY &lt;- NTD_ENERGY |&gt;\n  mutate(Mode=case_when(\n    Mode == \"AR\" ~ \"Alaska Railroad\", \n    Mode == \"CB\" ~ \"Commuter Bus\", \n    Mode == \"CC\" ~ \"Cable Car\",\n    Mode == \"CR\" ~ \"Commuter Rail\", \n    Mode == \"DR\" ~ \"Demand Response\", \n    Mode == \"FB\" ~ \"Ferryboat\", \n    Mode == \"HR\" ~ \"Heavy Rail\", \n    Mode == \"IP\" ~ \"Inclined Plane\", \n    Mode == \"LR\" ~ \"Light Rail\", \n    Mode == \"MB\" ~ \"Bus\", \n    Mode == \"MG\" ~ \"Monorail/Automated Guideway\", \n    Mode == \"PB\" ~ \"Publico\", \n    Mode == \"RB\" ~ \"Bus Rapid Transit\", \n    Mode == \"SR\" ~ \"Streetcar Rail\", \n    Mode == \"TB\" ~ \"Trolleybus\", \n    Mode == \"TR\" ~ \"Aerial Tramway\", \n    Mode == \"VP\" ~ \"Vanpool\", \n    Mode == \"YR\" ~ \"Hybrid Rail\", \n    TRUE ~ \"Unknown\"))\n\n# download the service by agency\nlibrary(readr)\n\nNTD_SERVICE_FILE &lt;- file.path(DATA_DIR, \"2023_service.csv\")\nif(!file.exists(NTD_SERVICE_FILE)){\n  DS &lt;- download.file(\"https://data.transportation.gov/resource/6y83-7vuw.csv\", \n                      destfile=NTD_SERVICE_FILE, \n                      method=\"curl\")\n  \n  if(DS | (file.info(NTD_SERVICE_FILE)$size == 0)){\n    cat(\"I was unable to download the NTD Service File. Please try again.\\n\")\n    stop(\"Download failed\")\n  }\n}\n\nNTD_SERVICE_RAW &lt;- read_csv(NTD_SERVICE_FILE)\n\n# clean it up\nNTD_SERVICE &lt;- NTD_SERVICE_RAW |&gt;\n  mutate(`NTD ID` = as.numeric(`_5_digit_ntd_id`)) |&gt; \n  rename(Agency = agency, \n         City   = max_city, \n         State  = max_state,\n         UPT    = sum_unlinked_passenger_trips_upt, \n         MILES  = sum_passenger_miles) |&gt;\n  select(matches(\"^[A-Z]\", ignore.case=FALSE)) |&gt;\n  filter(MILES &gt; 0)\n\n# Which transit service has the most UPT annually?\nmost_upt &lt;- NTD_SERVICE |&gt;\n  slice_max(UPT, n=1) |&gt;\n  mutate(UPT=number(UPT, big.mark=\",\"),\n         MILES=number(MILES,big.mark=\",\"))\nkable(most_upt, caption=\"Transit Service with the Most UPT Annually\")\n\n\n\nTransit Service with the Most UPT Annually\n\n\n\n\n\n\n\n\n\n\nAgency\nCity\nState\nUPT\nMILES\nNTD ID\n\n\n\n\nMTA New York City Transit\nBrooklyn\nNY\n2,632,003,044\n9,591,253,658\n20008\n\n\n\n\n\nCode\n# What is the average trip length of a trip on MTA NYC?\navg_length &lt;- NTD_SERVICE |&gt;\n  filter(Agency==\"MTA New York City Transit\") |&gt;\n  mutate(avg_length=MILES/UPT, big.mark=\",\") |&gt;\n  select(`NTD ID`, Agency, avg_length) |&gt;\n  rename(`Average Length`=avg_length)\nkable(avg_length,caption=\"Average Length of a Trip on MTA NYC\")\n\n\n\nAverage Length of a Trip on MTA NYC\n\n\nNTD ID\nAgency\nAverage Length\n\n\n\n\n20008\nMTA New York City Transit\n3.644089\n\n\n\n\n\nCode\n# Which transit service in NYC has the longest average trip length?\nlongest_transit &lt;- NTD_SERVICE |&gt;\n  filter(City %in% c(\"Brooklyn\", \"New York\", \"Staten Island\")) |&gt;\n  mutate(avg_trip_length=MILES/UPT) |&gt;\n  slice_max(avg_trip_length, n=1) |&gt;\n  rename(`Average Trip Length`=avg_trip_length)\nkable(longest_transit, caption=\"Transit Service in NYC with the longest average trip length\")\n\n\n\nTransit Service in NYC with the longest average trip length\n\n\n\n\n\n\n\n\n\n\n\nAgency\nCity\nState\nUPT\nMILES\nNTD ID\nAverage Trip Length\n\n\n\n\nMTA Long Island Rail Road\nNew York\nNY\n83835706\n2033685836\n20100\n24.25799\n\n\n\n\n\nCode\n# Which state has the fewest total miles travelled by public transit?\nstate_fewest_miles &lt;- NTD_SERVICE |&gt;\n  group_by(State) |&gt;\n  summarize(total_miles=sum(MILES)) |&gt;\n  slice_min(total_miles, n=1)\nkable(state_fewest_miles, caption=\"State with the Fewest Total Miles\")\n\n\n\nState with the Fewest Total Miles\n\n\nState\ntotal_miles\n\n\n\n\nNH\n3749892\n\n\n\n\n\nCode\n# Are all states represented in this data? If no, which ones are missing? The \n# state.name and state.abb objects we used above may be useful here.\nmissing_states &lt;- EIA_SEP_REPORT |&gt;\n  anti_join(NTD_SERVICE, join_by(\"abbreviation\"==\"State\")) |&gt;\n  select(state) |&gt;\n  rename(`Missing States`=state)\nkable(missing_states, caption=\"States that are not represented\")\n\n\n\nStates that are not represented\n\n\nMissing States\n\n\n\n\nArizona\n\n\nArkansas\n\n\nCalifornia\n\n\nColorado\n\n\nHawaii\n\n\nIowa\n\n\nKansas\n\n\nLouisiana\n\n\nMissouri\n\n\nMontana\n\n\nNebraska\n\n\nNevada\n\n\nNew Mexico\n\n\nNorth Dakota\n\n\nOklahoma\n\n\nSouth Dakota\n\n\nTexas\n\n\nUtah\n\n\nWyoming\n\n\n\n\n\nCode\n# join the three tables\nagency_mode &lt;- NTD_SERVICE |&gt;\n  inner_join(NTD_ENERGY |&gt;\n               select(-`Bunker Fuel`,-Ethanol, -Methonal,-Kerosene), \n             join_by(`NTD ID`==`NTD ID`)\n             ) |&gt;\n  inner_join(EIA_SEP_REPORT, join_by(State == abbreviation)) |&gt;\n  select(-`Agency Name`, -State) |&gt;\n  rename(\n    agency=Agency,\n    mode=Mode,\n    biodiesel=`Bio-Diesel`,\n    cnatgas=`C Natural Gas`,\n    diesel=`Diesel Fuel`,\n    ebat=`Electric Battery`,\n    epro=`Electric Propulsion`,\n    gas=Gasoline,\n    hy=Hydrogen,\n    lnatgas=`Liquified Nat Gas`,\n    lpetgas=`Liquified Petroleum Gas`,\n    co2_mwh=CO2_MWh\n  ) |&gt;\n  group_by(agency, mode)\n\n# co2_vol_mass &lt;- read_xlsx(\"data/mp02/co2_vol_mass.xlsx\")\n\nagency_mode &lt;- agency_mode |&gt; \n  mutate(total_co2_emissions=\n           biodiesel*22.45+\n           cnatgas*0.134/1000*120.85+\n           diesel*22.45+\n           ebat/1000*co2_mwh+\n           epro/1000*co2_mwh+\n           gas*20.86+\n           lnatgas*0.134/1000*120.85+\n           lpetgas*12.68\n         ) \n\nagency_mode2 &lt;- agency_mode |&gt;\n  select(-biodiesel,-cnatgas,-diesel,\n         -ebat, -epro, -gas,\n         -hy, -lnatgas, -lpetgas,\n         -co2_mwh, -primary_source, -electricity_price_MWh,\n         -generation_MWh\n         ) |&gt;\n  group_by(`NTD ID`) |&gt;\n  mutate(tot_emissions_agency=sum(total_co2_emissions))\n\nagency_mode3 &lt;- agency_mode2 |&gt;\n  select(`NTD ID`, agency, City, \n         state, UPT, MILES, \n         tot_emissions_agency) |&gt;\n  mutate(per_upt = tot_emissions_agency/UPT,\n         per_passenger_mile = per_upt/MILES) |&gt;\n  ungroup()\n\n# lowest emissions per upt\nlowest_emissions_upt &lt;- agency_mode3 |&gt;\n  select(`NTD ID`, agency, City,\n         state, per_upt) |&gt;\n  slice_min(per_upt, n=1)\nkable(lowest_emissions_upt, caption=\"Agency with the lowest co2 emissions per upt\")\n\n\n\nAgency with the lowest co2 emissions per upt\n\n\n\n\n\n\n\n\n\nNTD ID\nagency\nCity\nstate\nper_upt\n\n\n\n\n23\nCity of Seattle, dba: Seattle Center Monorail\nSeattle\nWashington\n0.0691556\n\n\n\n\n\nCode\n# lowest emissions per passenger mile\nlowest_emi_upt_mile &lt;- agency_mode3 |&gt;\n  select(`NTD ID`, agency, City,\n         state, per_passenger_mile) |&gt;\n  mutate(per_pm_mg=per_passenger_mile*453.592*1000) |&gt; # CO2 emissions in miligrams\n  slice_min(per_pm_mg, n=1, with_ties = FALSE)\nkable(lowest_emi_upt_mile, caption=\"Agency with the lowest emissions(miligram) per passenger mile\")\n\n\n\nAgency with the lowest emissions(miligram) per passenger mile\n\n\n\n\n\n\n\n\n\n\nNTD ID\nagency\nCity\nstate\nper_passenger_mile\nper_pm_mg\n\n\n\n\n20008\nMTA New York City Transit\nBrooklyn\nNew York\n0\n2.8e-05\n\n\n\n\n\nCode\n# finding the values that will define small, medium, and large sized agencies. \nsize_1 &lt;- quantile(agency_mode3 |&gt; select(UPT) |&gt; unique() |&gt; pull(UPT), 0.1)\nsize_2 &lt;- quantile(agency_mode3 |&gt; select(UPT) |&gt; unique() |&gt; pull(UPT), 0.4)\nsize_3 &lt;- quantile(agency_mode3 |&gt; select(UPT) |&gt; unique() |&gt; pull(UPT), 0.7)\n\nagency_mode4 &lt;- agency_mode3 |&gt;\n  filter(UPT &gt; size_1) |&gt;\n  mutate(size = case_when(\n    UPT &lt;= size_2 ~ \"Small\",\n    UPT &gt; size_2 & UPT &lt;= size_3 ~ \"Medium\",\n    UPT &gt; size_3 ~ \"Large\")) |&gt;\n  mutate(per_pm_mg=per_passenger_mile*453.592*1000)\n\n# greenest  agencies with different sizes\ngreenest_agencies &lt;- agency_mode4 |&gt;\n  select(size, agency, City,state, per_pm_mg) |&gt;\n  unique() |&gt;\n  group_by(size) |&gt;\n  slice_min(per_pm_mg, n=1)\nkable(greenest_agencies,caption=\"The greenest agencies by size\")\n\n\n\nThe greenest agencies by size\n\n\n\n\n\n\n\n\n\nsize\nagency\nCity\nstate\nper_pm_mg\n\n\n\n\nLarge\nMTA New York City Transit\nBrooklyn\nNew York\n0.0000280\n\n\nMedium\nBirmingham-Jefferson County Transit Authority\nBirmingham\nAlabama\n0.0139570\n\n\nSmall\nCity of Albany , dba: Albany Transit System\nAlbany\nGeorgia\n0.0251236\n\n\n\n\n\nCode\n# most emissions avioded\nmost_emissions_avoided &lt;- agency_mode4 |&gt;\n  unique() |&gt;\n  mutate(emission_avoided=MILES/49*20.86-tot_emissions_agency) |&gt;\n  group_by(size) |&gt;\n  slice_max(emission_avoided,n=1) |&gt;\n  select(size, agency, City, state, emission_avoided)\nkable(most_emissions_avoided, caption=\"Agencies with the most emissions avioded\")\n\n\n\nAgencies with the most emissions avioded\n\n\n\n\n\n\n\n\n\nsize\nagency\nCity\nstate\nemission_avoided\n\n\n\n\nLarge\nMTA New York City Transit\nBrooklyn\nNew York\n2523693827\n\n\nMedium\nHudson Transit Lines, Inc., dba: Short Line\nMahwah\nNew Jersey\n17934431\n\n\nSmall\nHampton Jitney, Inc.\nCalverton\nNew York\n11184078\n\n\n\n\n\nCode\n# highest percentage of electrification\nhighest_electrification &lt;- agency_mode |&gt;\n  mutate(elec=ebat+epro, other=biodiesel+cnatgas+\n           diesel+gas+hy+lnatgas+lpetgas) |&gt;\n  group_by(agency) |&gt;\n  mutate(tot_elec=sum(elec), tot_other=sum(other)) |&gt;\n  unique() |&gt;\n  mutate(elec_level=tot_elec/tot_other)\n\nhighest_electrification_agency &lt;- highest_electrification |&gt;\n  inner_join(agency_mode4, join_by(\"NTD ID\"==\"NTD ID\")) |&gt;\n  group_by(size) |&gt;\n  filter(elec_level!=Inf) |&gt;\n  slice_max(elec_level,n=1)|&gt;\n  select(size,agency.x,City.x,state.x,elec_level) |&gt;\n  unique()\nkable(highest_electrification_agency, caption=\"Agencies with the highest electrification level\")\n\n\n\nAgencies with the highest electrification level\n\n\n\n\n\n\n\n\n\nsize\nagency.x\nCity.x\nstate.x\nelec_level\n\n\n\n\nLarge\nTri-County Metropolitan Transportation District of Oregon, dba: TriMet\nPortland\nOregon\n117.43770\n\n\nMedium\nUniversity of Georgia, dba: Transportation and Parking Services\nAthens\nGeorgia\n10.36036\n\n\nSmall\nConnecticut Department of Transportation\nNewington\nConnecticut\n14.84685\n\n\n\n\n\nCode\n# worst of green agency\nworst_green_agency &lt;- highest_electrification |&gt;\n  inner_join(agency_mode4, join_by(\"NTD ID\"==\"NTD ID\")) |&gt;\n  group_by(size) |&gt;\n  filter(elec_level==0) |&gt;\n  slice_max(total_co2_emissions,n=1)|&gt;\n  select(size,agency.x,City.x,state.x,total_co2_emissions) |&gt;\n  unique()\nkable(worst_green_agency, caption=\"Agencies that are most 'un-green'\")\n\n\n\nAgencies that are most ‘un-green’\n\n\n\n\n\n\n\n\n\nsize\nagency.x\nCity.x\nstate.x\ntotal_co2_emissions\n\n\n\n\nLarge\nWashington State Ferries\nOlympia\nWashington\n344220193\n\n\nMedium\nSeaStreak, LLC\nAtlantic Highlands\nNew Jersey\n66376478\n\n\nSmall\nAlaska Railroad Corporation\nAnchorage\nAlaska\n21854963\n\n\n\n\n\nCode\n# visualization\n# Load necessary libraries\nlibrary(ggplot2)\nlibrary(dplyr)\n\n# Example data \ngreenest_agencies &lt;- data.frame(\n  size = c('Small', 'Medium', 'Large'),\n  agency = c('Agency A', 'Agency B', 'Agency C'),\n  City = c('City X', 'City Y', 'City Z'),\n  state = c('State 1', 'State 2', 'State 3'),\n  per_pm_mg = c(0.025, 0.013, 0.000)\n)\n\n# Create the bar plot\nggplot(greenest_agencies, aes(x = size, y = per_pm_mg, fill = size)) +\n  geom_bar(stat = 'identity', show.legend = FALSE) +\n  geom_text(aes(label = round(per_pm_mg, 3)), vjust = -0.3, size = 5) +\n  scale_fill_brewer(palette = \"Greens\") +\n  labs(\n    title = 'Greenest Agencies by Size',\n    x = 'Agency Size',\n    y = 'Green Score (per pm mg)'\n  ) +\n  theme_minimal()\n\n\n\n\n\n\n\n\n\nCode\n#another vis\n# Load necessary libraries\nlibrary(ggplot2)\nlibrary(dplyr)\n\n\n# Here is a sample structure\nmost_emissions_avoided &lt;- data.frame(\n  size = c('Small', 'Medium', 'Large'),\n  agency = c('Agency A', 'Agency B', 'Agency C'),\n  City = c('City X', 'City Y', 'City Z'),\n  state = c('State 1', 'State 2', 'State 3'),\n  emission_avoided = c(11000000, 17000000, 2523000000)\n)\n\n# Create a bar plot for the most emissions avoided by agency size\nggplot(most_emissions_avoided, aes(x = size, y = emission_avoided, fill = size)) +\n  geom_bar(stat = 'identity', show.legend = FALSE) +\n  geom_text(aes(label = round(emission_avoided, 0)), vjust = -0.3, size = 5) +\n  scale_fill_brewer(palette = \"Blues\") +\n  labs(\n    title = 'Most Emissions Avoided by Agencies',\n    x = 'Agency Size',\n    y = 'Emissions Avoided (in units)'\n  ) +\n  theme_minimal()\n\n\n\n\n\n\n\n\n\nCode\n# Save the plot as a PNG file\nggsave(\"my_plot.png\", plot = last_plot(), width = 8, height = 5)"
  }
]